<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>The Would Box - Feed Your Commitment</title>
    <link rel="manifest" href="would-manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
        }

        /* User Header */
        .user-header {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .user-info {
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
        }

        .partner-info {
            font-size: 14px;
            color: #764ba2;
            margin-top: 5px;
        }

        .pairing-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-top: 5px;
            background: #f0f0f0;
            color: #666;
        }

        .pairing-status.paired {
            background: #d4edda;
            color: #155724;
        }

        .pairing-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Feed Box Logo */
        .feed-box-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            position: relative;
        }

        .feed-box-logo svg {
            width: 100%;
            height: 100%;
        }

        /* Screens */
        .screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 28px;
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
        }

        h2 {
            font-size: 22px;
            margin-bottom: 15px;
            color: #667eea;
        }

        h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #764ba2;
        }

        /* Forms */
        input, textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
            display: inline-block;
            margin: 5px;
        }

        /* Needs List */
        .needs-list {
            list-style: none;
            margin: 20px 0;
        }

        .need-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .need-item.top-three {
            border-left: 4px solid gold;
            background: linear-gradient(90deg, rgba(255,215,0,0.1) 0%, #f8f9fa 100%);
        }

        /* Suggested Needs */
        .suggestions-container {
            margin: 20px 0;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 15px;
        }

        .suggestion-chip {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .suggestion-chip:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        /* Would Box Selection */
        .would-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .would-item.selected {
            background: #667eea;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        /* Priority List */
        .priority-list {
            margin: 20px 0;
        }

        .priority-item {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: move;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .priority-item.dragging {
            opacity: 0.5;
        }

        .priority-item.top-two {
            background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, white 100%);
            border-color: #667eea;
        }

        .priority-number {
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        /* Pairing Request */
        .pairing-request {
            background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(102,126,234,0.1) 100%);
            border: 2px solid #667eea;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .pairing-request h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        /* Daily Action */
        .action-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .action-text {
            font-size: 24px;
            margin: 20px 0;
            font-weight: 600;
        }

        /* Score Display */
        .score-display {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .score-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            margin: 0 10px;
        }

        .score-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .score-label {
            color: #666;
            margin-top: 5px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: #999;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 5px;
        }

        /* Pairing Code Display */
        .pairing-code {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .code-display {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 10px;
            margin: 10px 0;
        }

        /* Top Three Selector */
        .top-three-selector {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,215,0,0.05) 100%);
            border-radius: 15px;
            border: 2px dashed gold;
        }

        .top-three-selector h3 {
            color: #d4af37;
            margin-bottom: 10px;
        }

        .mb-80 {
            margin-bottom: 80px;
        }

        .notification {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .notification.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome" class="screen active">
        <h1>The Would Box</h1>
        <div class="feed-box-logo">
            <svg viewBox="0 0 100 100">
                <!-- Feed box base -->
                <rect x="20" y="40" width="60" height="40" fill="#8B4513" />
                <!-- Left lid (closed) -->
                <path d="M 20 40 L 50 20 L 50 40 L 20 40" fill="#A0522D" stroke="#654321" stroke-width="1"/>
                <!-- Right lid (opening) -->
                <path d="M 50 20 L 80 40 L 50 40" fill="#A0522D" stroke="#654321" stroke-width="1" transform-origin="50 30" style="animation: openLid 2s ease-in-out infinite alternate"/>
                <!-- Heart inside -->
                <path d="M 50 50 C 45 45, 35 45, 35 55 C 35 65, 50 75, 50 75 C 50 75, 65 65, 65 55 C 65 45, 55 45, 50 50" fill="#FF69B4" opacity="0.7"/>
                <style>
                    @keyframes openLid {
                        to { transform: rotate(-30deg); }
                    }
                </style>
            </svg>
        </div>
        <div class="card">
            <h2>Feed Your Commitment</h2>
            <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                Commitment grows through willing acts. The Would Box helps partners discover and serve each other's actual needs.
            </p>
            <button class="btn" onclick="startOnboarding()">Begin</button>
            <button class="btn btn-secondary" style="margin-top: 10px;" onclick="loginExisting()">I Have an Account</button>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setup" class="screen">
        <h1>Your Identity</h1>
        <div class="card">
            <input type="text" id="userName" placeholder="Your name" maxlength="20">
            <select id="userAge">
                <option value="">Select your age range</option>
                <option value="20-30">20-30</option>
                <option value="30-40">30-40</option>
                <option value="40-50">40-50</option>
                <option value="50-60">50-60</option>
                <option value="60+">60+</option>
            </select>
            <select id="userGender">
                <option value="">Select gender (for suggestions)</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other/Prefer not to say</option>
            </select>
            <input type="text" id="partnerName" placeholder="Your partner's name" maxlength="20">
            <button class="btn" onclick="createAccount()">Create Account</button>
        </div>
    </div>

    <!-- Needs List Screen -->
    <div id="needsList" class="screen mb-80">
        <div class="user-header">
            <div class="user-info">👤 <span id="currentUserName">User</span></div>
            <div class="partner-info">💑 Partner: <span id="currentPartnerName">Not paired</span></div>
            <div class="pairing-status" id="pairingStatusBadge">Not Paired</div>
        </div>
        
        <h1>My Needs</h1>
        
        <div class="card">
            <p style="margin-bottom: 15px; color: #666;">What do you need from your partner? (1-20 items)</p>
            <textarea id="newNeed" placeholder="Enter a need..." rows="2"></textarea>
            <button class="btn" onclick="addNeed()">Add Need</button>
        </div>

        <div class="card suggestions-container">
            <h3>💡 Popular Needs for Your Age/Gender</h3>
            <div id="suggestedNeeds"></div>
        </div>
        
        <div class="card">
            <h2>Current Needs (<span id="needsCount">0</span>/20)</h2>
            <ul id="needsListItems" class="needs-list"></ul>
        </div>

        <div class="card top-three-selector">
            <h3>🌟 Select Your Top 3 (Secret Triple Points)</h3>
            <p style="color: #666; font-size: 14px;">These won't be revealed to your partner but earn triple points when served.</p>
            <div id="topThreeList"></div>
        </div>

        <div class="card">
            <button class="btn" onclick="saveNeeds()">Save & Continue</button>
        </div>
    </div>

    <!-- Pairing Screen -->
    <div id="pairing" class="screen">
        <div class="user-header">
            <div class="user-info">👤 <span class="userName">User</span></div>
            <div class="partner-info">💑 Looking for: <span class="partnerName">Partner</span></div>
        </div>

        <h1>Connect Partners</h1>
        
        <div id="pendingRequest" class="pairing-request" style="display: none;">
            <h3>🔔 Pairing Request!</h3>
            <p><strong><span id="requesterName"></span></strong> wants to pair with you!</p>
            <button class="btn btn-small" onclick="acceptPairing()">Accept</button>
            <button class="btn btn-small btn-secondary" onclick="rejectPairing()">Decline</button>
        </div>

        <div class="card">
            <h2>Your Pairing Code</h2>
            <div class="pairing-code">
                <div class="code-display" id="pairingCode">----</div>
                <p style="color: #666; margin-top: 10px;">Share this with your partner</p>
            </div>
            <button class="btn btn-secondary" onclick="copyCode()">Copy Code</button>
        </div>
        
        <div class="card">
            <h2>Enter Partner's Code</h2>
            <input type="text" id="partnerCode" placeholder="Enter 4-digit code" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            <button class="btn" onclick="requestPairing()">Request Pairing</button>
        </div>

        <div id="pairingStatus" class="notification" style="display: none;"></div>
    </div>

    <!-- Partner's Needs (Would Selection) -->
    <div id="wouldSelection" class="screen mb-80">
        <div class="user-header">
            <div class="user-info">👤 <span class="userName">User</span></div>
            <div class="partner-info">💑 Serving: <span class="partnerName">Partner</span></div>
            <div class="pairing-status paired">Paired</div>
        </div>

        <h1>Partner's Needs</h1>
        <div class="card">
            <h2>Select 5 You Would Do</h2>
            <p style="color: #666; margin-bottom: 15px;">Choose what you're willing to commit to.</p>
            <div id="partnerNeedsList"></div>
            <p style="text-align: center; color: #667eea; font-weight: bold; margin-top: 10px;">
                Selected: <span id="selectedCount">0</span>/5
            </p>
        </div>
        
        <div class="card">
            <button class="btn" onclick="confirmWouldSelection()">Box These 5</button>
        </div>
    </div>

    <!-- Priority Setting -->
    <div id="prioritySetting" class="screen mb-80">
        <div class="user-header">
            <div class="user-info">👤 <span class="userName">User</span></div>
            <div class="partner-info">💑 For: <span class="partnerName">Partner</span></div>
        </div>

        <h1>Set Your Priorities</h1>
        <div class="card">
            <p style="color: #666; margin-bottom: 15px;">Drag to reorder. Top 2 earn double points!</p>
            <div id="priorityList" class="priority-list"></div>
            <button class="btn" onclick="savePriorities()">Save Priorities</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="screen mb-80">
        <div class="user-header">
            <div class="user-info">👤 <span class="userName">User</span></div>
            <div class="partner-info">💑 With: <span class="partnerName">Partner</span></div>
            <div class="pairing-status paired">Active</div>
        </div>

        <h1>The Would Box</h1>
        
        <div class="score-display">
            <div class="score-card">
                <div class="score-number" id="myScore">0</div>
                <div class="score-label">My Score</div>
            </div>
            <div class="score-card">
                <div class="score-number" id="partnerScore">0</div>
                <div class="score-label"><span class="partnerName">Partner</span>'s Score</div>
            </div>
        </div>

        <div class="action-card">
            <div style="font-size: 18px; opacity: 0.9;">Today's Would:</div>
            <div class="action-text" id="todaysAction">Loading...</div>
            <button class="btn" style="background: white; color: #667eea; margin-top: 20px;" onclick="markComplete()">Mark Complete</button>
        </div>

        <div class="card">
            <button class="btn btn-secondary" onclick="showWeeklyGuessing()">Weekly Guessing Game</button>
        </div>
    </div>

    <!-- Weekly Guessing -->
    <div id="weeklyGuessing" class="screen mb-80">
        <div class="user-header">
            <div class="user-info">👤 <span class="userName">User</span></div>
            <div class="partner-info">💑 Guessing: <span class="partnerName">Partner</span>'s Actions</div>
        </div>

        <h1>Weekly Guessing</h1>
        <div class="card">
            <h2>What Did <span class="partnerName">Your Partner</span> Work On?</h2>
            <p style="color: #666; margin-bottom: 15px;">Select all you think they completed this week.</p>
            <div id="guessingList"></div>
            <button class="btn" onclick="submitGuesses()">Submit Guesses</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav" style="display: none;">
        <a href="#" class="nav-item active" onclick="showDashboard(); return false;">
            <span class="nav-icon">🏠</span>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" onclick="showNeedsList(); return false;">
            <span class="nav-icon">📝</span>
            <span>Needs</span>
        </a>
        <a href="#" class="nav-item" onclick="showWouldList(); return false;">
            <span class="nav-icon">📦</span>
            <span>Would</span>
        </a>
        <a href="#" class="nav-item" onclick="showScores(); return false;">
            <span class="nav-icon">🏆</span>
            <span>Score</span>
        </a>
    </div>

    <script>
        // The Would Box - Core Logic v2 with Suggestions & Better Pairing

        // Suggested Needs Database
        const suggestedNeedsDB = {
            "male": {
                "20-30": [
                    "Help keeping apartment clean",
                    "Join me at the gym 2x week",
                    "Plan weekend adventures",
                    "Cook healthy meals together",
                    "Morning coffee in bed",
                    "Gaming/hobby time without guilt",
                    "Help with career goals",
                    "Regular date nights"
                ],
                "30-40": [
                    "Help with morning routine",
                    "Take over bedtime with kids",
                    "Plan date nights monthly",
                    "Handle weekend breakfast",
                    "Manage one household project",
                    "Support my fitness goals",
                    "Share financial planning",
                    "Quiet time to decompress"
                ],
                "40-50": [
                    "Exercise partner 3x week",
                    "Handle teen driving practice",
                    "Plan quarterly getaways",
                    "Take over bills/finances",
                    "Organize garage/storage",
                    "Support aging parents",
                    "Share home maintenance",
                    "Intimacy without pressure"
                ],
                "50-60": [
                    "Morning walks together",
                    "Handle all tech support",
                    "Plan retirement together",
                    "Coordinate medical appointments",
                    "Maintain garden/yard",
                    "Regular couple's activities",
                    "Help with diet changes",
                    "Travel planning"
                ],
                "60+": [
                    "Daily walks together",
                    "Medication reminders",
                    "Drive to appointments",
                    "Learn new hobbies together",
                    "Handle online tasks",
                    "Regular social activities",
                    "Help with physical tasks",
                    "Memory support"
                ]
            },
            "female": {
                "20-30": [
                    "Listen without fixing",
                    "Surprise flowers weekly",
                    "Help with meal prep Sundays",
                    "Clean bathroom regularly",
                    "Plan romantic surprises",
                    "Compliment daily",
                    "Support career ambitions",
                    "Share mental load"
                ],
                "30-40": [
                    "Take kids for solo time",
                    "Handle morning routine",
                    "Book date nights monthly",
                    "Emotional check-ins daily",
                    "Share household decisions",
                    "Appreciate efforts verbally",
                    "Help with school activities",
                    "Maintain romance"
                ],
                "40-50": [
                    "Notice appearance changes",
                    "Support health goals",
                    "Plan surprise dates",
                    "Handle dinner 2x week",
                    "Listen to work stress",
                    "Share emotional labor",
                    "Support friend time",
                    "Physical affection daily"
                ],
                "50-60": [
                    "Daily appreciation",
                    "Support health changes",
                    "Plan couple activities",
                    "Handle heavy tasks",
                    "Travel together more",
                    "Share household equally",
                    "Regular compliments",
                    "Emotional intimacy"
                ],
                "60+": [
                    "Daily companionship",
                    "Help with technology",
                    "Share memories often",
                    "Handle driving duties",
                    "Plan social activities",
                    "Physical assistance",
                    "Patience with changes",
                    "Regular affection"
                ]
            },
            "other": {
                "20-30": ["Quality time together", "Active listening", "Share responsibilities", "Support goals", "Regular appreciation"],
                "30-40": ["Work-life balance", "Share parenting", "Date nights", "Emotional support", "Household equity"],
                "40-50": ["Health support", "Share planning", "Maintain intimacy", "Support changes", "Adventure together"],
                "50-60": ["Companionship", "Health focus", "Travel plans", "Support transitions", "Daily appreciation"],
                "60+": ["Daily support", "Health assistance", "Social activities", "Patience", "Companionship"]
            }
        };

        // Generate unique user ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // App State with proper user isolation
        let currentUser = {
            id: null,
            name: '',
            age: '',
            gender: '',
            partnerName: '',
            pairingCode: null,
            partnerId: null,
            partnerCode: null,
            isPaired: false,
            pairingStatus: 'none', // none, requested, pending, paired
            needs: [], // My needs from partner
            topThree: [], // Secret top 3 needs (triple points)
            woulds: [], // 5 things I would do from partner's needs
            priorities: [], // Ordered woulds with top 2 getting double points
            completedThisWeek: [],
            guessedThisWeek: [],
            score: 0,
            partnerScore: 0,
            lastDaily: null,
            todaysWould: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            setInterval(checkForPairingRequests, 5000); // Check every 5 seconds
        });

        // User Management
        function loadUserData() {
            const userId = localStorage.getItem('wouldbox_userId');
            if (userId) {
                const userData = localStorage.getItem(`wouldbox_${userId}`);
                if (userData) {
                    currentUser = JSON.parse(userData);
                    if (currentUser.name) {
                        updateAllUserNames();
                        if (currentUser.isPaired) {
                            showDashboard();
                        } else {
                            showPairing();
                        }
                        updateNavigation(true);
                    }
                }
            }
        }

        function saveUserData() {
            if (!currentUser.id) {
                currentUser.id = generateUserId();
                localStorage.setItem('wouldbox_userId', currentUser.id);
            }
            localStorage.setItem(`wouldbox_${currentUser.id}`, JSON.stringify(currentUser));
            
            // Save to shared space for partner access
            if (currentUser.pairingCode) {
                const sharedData = {
                    userId: currentUser.id,
                    name: currentUser.name,
                    needs: currentUser.needs.map(n => ({ text: n.text, id: n.id })),
                    woulds: currentUser.woulds,
                    completedThisWeek: currentUser.completedThisWeek,
                    isPaired: currentUser.isPaired,
                    partnerId: currentUser.partnerId,
                    partnerName: currentUser.partnerName
                };
                localStorage.setItem(`wouldbox_shared_${currentUser.pairingCode}`, JSON.stringify(sharedData));
            }
            
            updateAllUserNames();
        }

        // Update all user name displays
        function updateAllUserNames() {
            // Update all elements with userName class
            document.querySelectorAll('.userName, #currentUserName').forEach(el => {
                el.textContent = currentUser.name || 'User';
            });
            
            // Update all elements with partnerName class
            document.querySelectorAll('.partnerName, #currentPartnerName').forEach(el => {
                el.textContent = currentUser.partnerName || 'Partner';
            });
            
            // Update pairing status badge
            const badge = document.getElementById('pairingStatusBadge');
            if (badge) {
                if (currentUser.isPaired) {
                    badge.textContent = 'Paired ✓';
                    badge.className = 'pairing-status paired';
                } else if (currentUser.pairingStatus === 'requested') {
                    badge.textContent = 'Request Sent';
                    badge.className = 'pairing-status pending';
                } else if (currentUser.pairingStatus === 'pending') {
                    badge.textContent = 'Request Received';
                    badge.className = 'pairing-status pending';
                } else {
                    badge.textContent = 'Not Paired';
                    badge.className = 'pairing-status';
                }
            }
        }

        // Navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            updateAllUserNames();
        }

        function updateNavigation(show) {
            document.querySelector('.bottom-nav').style.display = show ? 'flex' : 'none';
        }

        // Onboarding Flow
        function startOnboarding() {
            showScreen('setup');
        }

        function loginExisting() {
            const code = prompt('Enter your 4-digit code:');
            if (code && code.length === 4) {
                // Try to load user by code
                const allKeys = Object.keys(localStorage);
                for (let key of allKeys) {
                    if (key.startsWith('wouldbox_user_')) {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData.pairingCode === code) {
                            currentUser = userData;
                            localStorage.setItem('wouldbox_userId', currentUser.id);
                            updateAllUserNames();
                            if (currentUser.isPaired) {
                                showDashboard();
                            } else {
                                showPairing();
                            }
                            updateNavigation(true);
                            return;
                        }
                    }
                }
                alert('Account not found. Please create a new account.');
            }
        }

        function createAccount() {
            const name = document.getElementById('userName').value.trim();
            const age = document.getElementById('userAge').value;
            const gender = document.getElementById('userGender').value;
            const partnerName = document.getElementById('partnerName').value.trim();
            
            if (!name || !partnerName || !age || !gender) {
                alert('Please fill in all fields');
                return;
            }
            
            currentUser.name = name;
            currentUser.age = age;
            currentUser.gender = gender;
            currentUser.partnerName = partnerName;
            currentUser.pairingCode = Math.floor(1000 + Math.random() * 9000).toString();
            
            saveUserData();
            showNeedsList();
            updateNavigation(true);
        }

        // Needs Management
        function showNeedsList() {
            showScreen('needsList');
            renderNeedsList();
            renderTopThreeSelector();
            renderSuggestedNeeds();
        }

        function renderSuggestedNeeds() {
            const container = document.getElementById('suggestedNeeds');
            const suggestions = suggestedNeedsDB[currentUser.gender]?.[currentUser.age] || 
                              suggestedNeedsDB['other'][currentUser.age] || [];
            
            container.innerHTML = suggestions.map(need => 
                `<span class="suggestion-chip" onclick="addSuggestedNeed('${need.replace(/'/g, "\\'")}')">${need}</span>`
            ).join('');
        }

        function addSuggestedNeed(needText) {
            document.getElementById('newNeed').value = needText;
            addNeed();
        }

        function addNeed() {
            const input = document.getElementById('newNeed');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (currentUser.needs.length >= 20) {
                alert('Maximum 20 needs allowed');
                return;
            }
            
            const need = {
                id: Date.now(),
                text: text,
                isTopThree: false
            };
            
            currentUser.needs.push(need);
            input.value = '';
            
            renderNeedsList();
            renderTopThreeSelector();
            saveUserData();
        }

        function renderNeedsList() {
            const container = document.getElementById('needsListItems');
            const countEl = document.getElementById('needsCount');
            
            countEl.textContent = currentUser.needs.length;
            
            container.innerHTML = currentUser.needs.map(need => `
                <li class="need-item ${currentUser.topThree.includes(need.id) ? 'top-three' : ''}">
                    <span>${need.text}</span>
                    <button onclick="removeNeed(${need.id})" style="background: none; border: none; color: #ff4444; cursor: pointer;">❌</button>
                </li>
            `).join('');
        }

        function renderTopThreeSelector() {
            const container = document.getElementById('topThreeList');
            container.innerHTML = currentUser.needs.map(need => `
                <label style="display: block; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" 
                           value="${need.id}" 
                           ${currentUser.topThree.includes(need.id) ? 'checked' : ''}
                           onchange="toggleTopThree(${need.id})"
                           style="margin-right: 10px;">
                    ${need.text}
                </label>
            `).join('');
        }

        function toggleTopThree(needId) {
            const index = currentUser.topThree.indexOf(needId);
            if (index > -1) {
                currentUser.topThree.splice(index, 1);
            } else {
                if (currentUser.topThree.length >= 3) {
                    alert('You can only select 3 top needs');
                    event.target.checked = false;
                    return;
                }
                currentUser.topThree.push(needId);
            }
            renderNeedsList();
            saveUserData();
        }

        function removeNeed(needId) {
            currentUser.needs = currentUser.needs.filter(n => n.id !== needId);
            currentUser.topThree = currentUser.topThree.filter(id => id !== needId);
            renderNeedsList();
            renderTopThreeSelector();
            saveUserData();
        }

        function saveNeeds() {
            if (currentUser.needs.length < 1) {
                alert('Please add at least 1 need before continuing');
                return;
            }
            
            saveUserData();
            showPairing();
        }

        // Pairing - FIXED VERSION
        function showPairing() {
            showScreen('pairing');
            document.getElementById('pairingCode').textContent = currentUser.pairingCode;
            checkForPairingRequests();
        }

        function copyCode() {
            navigator.clipboard.writeText(currentUser.pairingCode);
            alert('Code copied to clipboard!');
        }

        function requestPairing() {
            const code = document.getElementById('partnerCode').value;
            if (code.length !== 4) {
                alert('Please enter a 4-digit code');
                return;
            }
            
            // Store pairing request
            const requestKey = `wouldbox_pairing_${code}`;
            const request = {
                requesterCode: currentUser.pairingCode,
                requesterName: currentUser.name,
                requesterId: currentUser.id,
                timestamp: Date.now()
            };
            localStorage.setItem(requestKey, JSON.stringify(request));
            
            currentUser.partnerCode = code;
            currentUser.pairingStatus = 'requested';
            saveUserData();
            
            // Show status
            const status = document.getElementById('pairingStatus');
            status.className = 'notification';
            status.textContent = 'Pairing request sent! Waiting for partner to accept...';
            status.style.display = 'block';
        }

        function checkForPairingRequests() {
            // Check if we have a pending request
            const requestKey = `wouldbox_pairing_${currentUser.pairingCode}`;
            const request = localStorage.getItem(requestKey);
            
            if (request) {
                const data = JSON.parse(request);
                // Don't show our own request
                if (data.requesterId !== currentUser.id) {
                    // Show pending request
                    document.getElementById('pendingRequest').style.display = 'block';
                    document.getElementById('requesterName').textContent = data.requesterName;
                    currentUser.pairingStatus = 'pending';
                    saveUserData();
                }
            }
            
            // Check if our request was accepted
            if (currentUser.pairingStatus === 'requested' && currentUser.partnerCode) {
                const acceptKey = `wouldbox_pairing_accepted_${currentUser.pairingCode}`;
                const accepted = localStorage.getItem(acceptKey);
                if (accepted) {
                    completePairing(currentUser.partnerCode);
                    localStorage.removeItem(acceptKey);
                }
            }
        }

        function acceptPairing() {
            const requestKey = `wouldbox_pairing_${currentUser.pairingCode}`;
            const request = JSON.parse(localStorage.getItem(requestKey));
            
            if (request) {
                // Mark as accepted for the requester
                const acceptKey = `wouldbox_pairing_accepted_${request.requesterCode}`;
                localStorage.setItem(acceptKey, 'true');
                
                // Complete pairing on our end
                currentUser.partnerCode = request.requesterCode;
                completePairing(request.requesterCode);
                
                // Clean up
                localStorage.removeItem(requestKey);
                document.getElementById('pendingRequest').style.display = 'none';
            }
        }

        function rejectPairing() {
            const requestKey = `wouldbox_pairing_${currentUser.pairingCode}`;
            localStorage.removeItem(requestKey);
            document.getElementById('pendingRequest').style.display = 'none';
            currentUser.pairingStatus = 'none';
            saveUserData();
        }

        function completePairing(partnerCode) {
            // Get partner's shared data
            const partnerData = localStorage.getItem(`wouldbox_shared_${partnerCode}`);
            if (!partnerData) {
                alert('Partner data not found. Make sure they have created their needs list.');
                return;
            }
            
            const partner = JSON.parse(partnerData);
            currentUser.partnerId = partner.userId;
            currentUser.partnerCode = partnerCode;
            currentUser.isPaired = true;
            currentUser.pairingStatus = 'paired';
            currentUser.partnerName = partner.name; // Update with actual partner name
            
            // Store partner's needs for would selection
            localStorage.setItem(`wouldbox_partner_needs_${currentUser.id}`, JSON.stringify(partner.needs));
            
            saveUserData();
            
            // Show success
            const status = document.getElementById('pairingStatus');
            status.className = 'notification success';
            status.textContent = `Successfully paired with ${partner.name}!`;
            status.style.display = 'block';
            
            setTimeout(() => {
                showWouldSelection();
            }, 2000);
        }

        // Would Selection
        function showWouldSelection() {
            showScreen('wouldSelection');
            const partnerNeeds = JSON.parse(localStorage.getItem(`wouldbox_partner_needs_${currentUser.id}`) || '[]');
            
            const container = document.getElementById('partnerNeedsList');
            container.innerHTML = partnerNeeds.map(need => `
                <div class="would-item" onclick="toggleWould('${need.id}', this)">
                    ${need.text}
                </div>
            `).join('');
        }

        let selectedWoulds = [];

        function toggleWould(needId, element) {
            const index = selectedWoulds.indexOf(needId);
            
            if (index > -1) {
                selectedWoulds.splice(index, 1);
                element.classList.remove('selected');
            } else {
                if (selectedWoulds.length >= 5) {
                    alert('You can only select 5 items');
                    return;
                }
                selectedWoulds.push(needId);
                element.classList.add('selected');
            }
            
            document.getElementById('selectedCount').textContent = selectedWoulds.length;
        }

        function confirmWouldSelection() {
            if (selectedWoulds.length !== 5) {
                alert('Please select exactly 5 items');
                return;
            }
            
            currentUser.woulds = selectedWoulds;
            saveUserData();
            showPrioritySetting();
        }

        // Priority Setting
        function showPrioritySetting() {
            showScreen('prioritySetting');
            
            const partnerNeeds = JSON.parse(localStorage.getItem(`wouldbox_partner_needs_${currentUser.id}`) || '[]');
            const container = document.getElementById('priorityList');
            
            currentUser.priorities = currentUser.woulds.slice(); // Copy woulds as initial order
            
            container.innerHTML = currentUser.priorities.map((wouldId, index) => {
                const need = partnerNeeds.find(n => n.id == wouldId);
                return `
                    <div class="priority-item ${index < 2 ? 'top-two' : ''}" 
                         draggable="true" 
                         data-id="${wouldId}">
                        <div class="priority-number">${index + 1}</div>
                        <div>${need ? need.text : ''}</div>
                    </div>
                `;
            }).join('');
            
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const items = document.querySelectorAll('.priority-item');
            let draggedItem = null;
            
            items.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    this.classList.add('dragging');
                });
                
                item.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (this !== draggedItem) {
                        const allItems = [...document.querySelectorAll('.priority-item')];
                        const draggedIndex = allItems.indexOf(draggedItem);
                        const targetIndex = allItems.indexOf(this);
                        
                        if (draggedIndex < targetIndex) {
                            this.parentNode.insertBefore(draggedItem, this.nextSibling);
                        } else {
                            this.parentNode.insertBefore(draggedItem, this);
                        }
                        
                        updatePriorityOrder();
                    }
                });
            });
        }

        function updatePriorityOrder() {
            const items = document.querySelectorAll('.priority-item');
            currentUser.priorities = [];
            
            items.forEach((item, index) => {
                const wouldId = item.dataset.id;
                currentUser.priorities.push(wouldId);
                
                // Update number and styling
                item.querySelector('.priority-number').textContent = index + 1;
                item.classList.toggle('top-two', index < 2);
            });
        }

        function savePriorities() {
            saveUserData();
            showDashboard();
        }

        // Dashboard
        function showDashboard() {
            if (!currentUser.isPaired) {
                showPairing();
                return;
            }
            showScreen('dashboard');
            updateDashboard();
        }

        function updateDashboard() {
            document.getElementById('myScore').textContent = currentUser.score || 0;
            document.getElementById('partnerScore').textContent = currentUser.partnerScore || 0;
            
            // Get today's would
            const today = new Date().toDateString();
            if (currentUser.lastDaily !== today && currentUser.priorities && currentUser.priorities.length > 0) {
                // Pick random would for today
                const randomIndex = Math.floor(Math.random() * currentUser.priorities.length);
                currentUser.todaysWould = currentUser.priorities[randomIndex];
                currentUser.lastDaily = today;
                saveUserData();
            }
            
            // Display today's would
            const partnerNeeds = JSON.parse(localStorage.getItem(`wouldbox_partner_needs_${currentUser.id}`) || '[]');
            const todaysNeed = partnerNeeds.find(n => n.id == currentUser.todaysWould);
            document.getElementById('todaysAction').textContent = todaysNeed ? todaysNeed.text : 'Set up your Would list first';
        }

        function markComplete() {
            if (!currentUser.todaysWould) return;
            
            if (!currentUser.completedThisWeek.includes(currentUser.todaysWould)) {
                currentUser.completedThisWeek.push(currentUser.todaysWould);
                saveUserData();
                alert('Marked as complete! Your partner will guess this in the weekly review.');
            } else {
                alert('Already completed this week!');
            }
        }

        // Weekly Guessing Game
        function showWeeklyGuessing() {
            showScreen('weeklyGuessing');
            
            if (!currentUser.partnerCode) {
                alert('Not paired yet');
                return;
            }
            
            // Get partner's shared data
            const partnerData = localStorage.getItem(`wouldbox_shared_${currentUser.partnerCode}`);
            if (!partnerData) {
                alert('Partner data not found');
                return;
            }
            
            const partner = JSON.parse(partnerData);
            const container = document.getElementById('guessingList');
            
            // Show my needs that partner selected as woulds
            const myNeedsTheyWould = currentUser.needs.filter(need => 
                partner.woulds && partner.woulds.includes(need.id.toString())
            );
            
            container.innerHTML = myNeedsTheyWould.map(need => `
                <label style="display: block; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" value="${need.id}" style="margin-right: 10px;">
                    ${need.text}
                </label>
            `).join('');
        }

        function submitGuesses() {
            const checkboxes = document.querySelectorAll('#guessingList input:checked');
            const guesses = Array.from(checkboxes).map(cb => cb.value);
            
            // Get partner's completed items
            const partnerData = JSON.parse(localStorage.getItem(`wouldbox_shared_${currentUser.partnerCode}`));
            const partnerCompleted = partnerData.completedThisWeek || [];
            
            let correctGuesses = 0;
            guesses.forEach(guess => {
                if (partnerCompleted.includes(guess)) {
                    correctGuesses++;
                    
                    // Check if it was a top priority (double points)
                    const priorityIndex = currentUser.priorities.indexOf(guess);
                    if (priorityIndex < 2) {
                        currentUser.partnerScore += 2; // Double points for top 2
                    } else {
                        currentUser.partnerScore += 1;
                    }
                    
                    // Check if it was a top 3 need (triple points)
                    if (currentUser.topThree.includes(parseInt(guess))) {
                        currentUser.partnerScore += 2; // Additional 2 points (total 3)
                    }
                }
                currentUser.score += 1; // 1 point for each guess
            });
            
            saveUserData();
            alert(`You got ${correctGuesses} correct! Points earned: ${currentUser.score}`);
            showDashboard();
        }

        // Additional Navigation Functions
        function showWouldList() {
            if (!currentUser.isPaired) {
                alert('Please pair with your partner first');
                showPairing();
                return;
            }
            if (currentUser.woulds.length === 0) {
                showWouldSelection();
            } else {
                showPrioritySetting();
            }
        }

        function showScores() {
            showWeeklyGuessing();
        }
    </script>
</body>
</html>
